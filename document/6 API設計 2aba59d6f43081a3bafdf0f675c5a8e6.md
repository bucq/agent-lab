# 6. API設計

フロントエンドとバックエンド間のAPI仕様を定義します。

## 設計原則

### Adapterパターンによる統一インターフェース

**目的**

- フロントエンドは単一のAPI仕様のみを知る
- バックエンドで異なるLLM SDK実装を切り替え
- 新しいSDK追加時もフロントエンド変更不要

**メリット**

- 柔軟な技術スタック移行
- フロントエンドとバックエンドの疑結合
- 複数SDKの並行開発が可能

---

## エンドポイント一覧

### 1. エージェント一覧取得

**エンドポイント**

```
GET /api/agents
```

**リクエスト**

- パラメータなし

**レスポンス** (200 OK)

```json
{
  "agents": [
    {
      "id": "default-chat",
      "name": "汎用チャット",
      "description": "一般的な質問に対応するエージェント",
      "supports_mcp": false,
      "is_default": true
    },
    {
      "id": "web-scraper",
      "name": "Webスクレイパー",
      "description": "Webページを取得・分析するエージェント",
      "supports_mcp": true,
      "is_default": false
    }
  ]
}
```

**フィールド説明**

- `id`: エージェントの一意識別子
- `name`: 表示名
- `description`: 説明文
- `supports_mcp`: MCPツール対応有無
- `is_default`: デフォルトエージェントかどうか

---

### 2. チャットストリーミング

**エンドポイント**

```
POST /api/chat/stream
Content-Type: application/json
```

**リクエストボディ**

```json
{
  "agent_id": "web-scraper",
  "message": "[https://example.com](https://example.com) のタイトルを教えて",
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "history": [
    {
      "role": "user",
      "content": "前のメッセージ"
    },
    {
      "role": "assistant",
      "content": "前の応答"
    }
  ]
}
```

**フィールド説明**

- `agent_id`: 使用するエージェントID (必須)
- `message`: ユーザーメッセージ (必須)
- `session_id`: セッションID (UUID v4) (必須)
- `history`: 会話履歴 (オプション, デフォルト: [])

**レスポンス** (Server-Sent Events)

```
event: message
data: {"type": "text", "content": "確認"}

event: message
data: {"type": "text", "content": "します"}

event: tool_call
data: {"tool": "web_scraper", "status": "running"}

event: tool_result
data: {"tool": "web_scraper", "result": "タイトル: Example Domain"}

event: message
data: {"type": "text", "content": "タイトルは"}

event: done
data: {"message_id": "msg-123"}
```

**イベントタイプ**

1. **message** - テキストチャンク

```json
{
  "type": "text",
  "content": "文字列"
}
```

1. **tool_call** - ツール呼び出し開始

```json
{
  "type": "tool_call",
  "tool": "ツール名",
  "status": "running"
}
```

1. **tool_result** - ツール実行結果

```json
{
  "type": "tool_result",
  "tool": "ツール名",
  "result": "結果データ"
}
```

1. **done** - ストリーム終了

```json
{
  "type": "done",
  "message_id": "msg-xxx"
}
```

1. **error** - エラー発生

```json
{
  "type": "error",
  "error": "エラーメッセージ"
}
```

**エラーレスポンス**

400 Bad Request

```json
{
  "detail": "Invalid agent_id"
}
```

500 Internal Server Error

```json
{
  "detail": "Internal server error"
}
```

---

## Phase 2: 追加エンドポイント

### 3. セッション一覧取得

```
GET /api/sessions
```

**レスポンス**

```json
{
  "sessions": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "created_at": "2024-01-15T10:30:00Z",
      "updated_at": "2024-01-15T11:00:00Z",
      "message_count": 10
    }
  ]
}
```

### 4. セッション作成

```
POST /api/sessions
```

**レスポンス**

```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "created_at": "2024-01-15T10:30:00Z"
}
```

### 5. セッション詳細取得

```
GET /api/sessions/{session_id}
```

**レスポンス**

```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "created_at": "2024-01-15T10:30:00Z",
  "messages": [
    {
      "id": "msg-1",
      "role": "user",
      "content": "メッセージ",
      "timestamp": "2024-01-15T10:30:00Z"
    }
  ]
}
```

### 6. セッション削除

```
DELETE /api/sessions/{session_id}
```

**レスポンス**

```json
{
  "message": "Session deleted successfully"
}
```

### 7. ファイルアップロード

```
POST /api/files/upload
Content-Type: multipart/form-data
```

**リクエスト**

- `file`: ファイル (PDF/TXT/MD)
- `session_id`: セッションID

**レスポンス**

```json
{
  "file_id": "file-123",
  "filename": "document.pdf",
  "url": "[https://s3.../document.pdf](https://s3.../document.pdf)"
}
```

---

## 認証 (Phase 3)

### Header

```
Authorization: Bearer <JWT_TOKEN>
```

### エラーレスポンス

401 Unauthorized

```json
{
  "detail": "Invalid or expired token"
}
```

---

## レート制限 (Phase 2)

**制限**

- 100 requests / hour / user

**Headerレスポンス**

```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1610712000
```

**エラーレスポンス**

429 Too Many Requests

```json
{
  "detail": "Rate limit exceeded"
}
```

---

## CORS設定

### MVP

```python
allow_origins = [
    "[http://localhost:8501](http://localhost:8501)",
    "[http://127.0.0.1:8501](http://127.0.0.1:8501)"
]
```

### Phase 2

```python
allow_origins = [
    "[https://yourdomain.com](https://yourdomain.com)",
    "[http://localhost:3000](http://localhost:3000)"  # 開発用
]
```