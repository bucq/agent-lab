# 7. バックエンド設計

バックエンドの詳細設計と主要コンポーネントの説明を記載します。

## Agentアーキテクチャ

### BaseAgent 抽象基底クラス

**目的**

- すべてのエージェント実装が継承する共通インターフェース
- 複数のLLM SDKを統一的に扱う

**必須メソッド**

1. **stream_chat()**
    - 引数: `message: str`, `history: List[Dict]`, `session_id: str`
    - 戻り値: `AsyncGenerator[Dict[str, Any], None]`
    - 機能: チャットメッセージをストリーミング処理
2. **get_agent_info()**
    - 引数: なし
    - 戻り値: `Dict[str, Any]`
    - 機能: エージェント情報を返す
3. **supports_mcp()**
    - 引数: なし
    - 戻り値: `bool`
    - 機能: MCP対応有無を返す

**プロパティ**

- `agent_id`: エージェントID
- `name`: 表示名
- `description`: 説明文

---

### 具体実装クラス

### 1. DefaultAgent

**概要**

- シンプルなチャットエージェント
- MCP統合なし
- LM Studio直接接続

**特徴**

- デフォルトエージェント
- 最もシンプルな実装
- ストリーミング対応

**使用ケース**

- 一般的な質問
- ツール不要な会話

### 2. OpenAIAgent

**概要**

- OpenAI SDKを使用したエージェント
- MCPツール統合
- Function Calling対応

**特徵**

- MCP Clientを保持
- ツール一覧を動的に取得
- ツール呼び出しを検出・実行

**使用ケース**

- Webスクレイピング
- 外部API呼び出し

### 3. AWSAgent (Phase 2)

**概要**

- AWS Bedrock SDK使用
- Lambda環境で実行

**特徵**

- Claude 3.5 Sonnet対応
- AWSサービス統合

### 4. ADKAgent (Phase 4)

**概要**

- Anthropic SDK使用
- 別リポジトリで開発

---

## Agent Factory

**目的**

- エージェントの登録・管理
- エージェントIDからインスタンス取得

**主要メソッド**

1. **register_agent()**
    - エージェントをFactoryに登録
2. **get_agent(agent_id)**
    - IDからエージェントインスタンス取得
3. **list_agents()**
    - 全エージェント情報をリストで返す

**登録例**

MVP時の登録エージェント:

- default-chat: DefaultAgent
- web-scraper: OpenAIAgent (MCP有効)

---

## MCP統合設計

### MCP Client

**目的**

- 複数MCPサーバーへの接続管理
- ツール一覧取得
- ツール実行

**主要メソッド**

1. **initialize_servers(server_names)**
    - 指定されたMCPサーバーに接続
2. **get_tools()**
    - 全ツール一覧を取得
    - OpenAI Function Calling形式で返す
3. **call_tool(tool_name, arguments)**
    - 指定ツールを実行
    - 結果を返す

**設定ファイル (servers.json)**

```json
{
  "mcp-server-fetch": {
    "command": "npx",
    "args": ["-y", "@modelcontextprotocol/server-fetch"],
    "env": {}
  }
}
```

**フィールド説明**

- `command`: 実行コマンド
- `args`: コマンド引数
- `env`: 環境変数

### ツール実行フロー

1. AgentがLLMにメッセージとツール一覧を送信
2. LLMがツール呼び出しを決定
3. Agentがツール呼び出しを検出
4. MCP Clientがツールを実行
5. 結果をLLMに返す
6. LLMが最終回答を生成
7. ストリーミングでユーザーに返す

---

## ストリーミング実装

### Server-Sent Events (SSE)

**選定理由**

- HTTP/1.1で動作
- シンプルな実装
- 単方向ストリーミングに最適

**FastAPI実装**

ポイント:

- `StreamingResponse` 使用
- `AsyncGenerator` でチャンク送信
- `media_type="text/event-stream"`

**イベント形式**

```
event: <イベントタイプ>
data: <JSONデータ>

```

**イベントタイプ**

- `message`: テキストチャンク
- `tool_call`: ツール呼び出し
- `tool_result`: ツール結果
- `done`: 完了
- `error`: エラー

---

## セッション管理

### MVP: インメモリ管理

**実装**

- Pythonの辞書で管理
- UUID v4でセッションID生成

**Sessionクラス**

- `session_id`: UUID
- `messages`: 会話履歴
- `current_agent_id`: 選択中エージェント
- `created_at`: 作成日時

**制限事項**

- サーバー再起動で消失
- 永続化なし
- MVPでは許容

### Phase 2: DB永続化

**実装**

- PostgreSQL RDS
- SQLAlchemy ORM
- Alembicマイグレーション

**テーブル設計**

- sessionsテーブル
- messagesテーブル

---

## エラーハンドリング

### エラータイプ

1. **バリデーションエラー**
    - 不正なリクエストパラメータ
    - 400 Bad Request
2. **Agentエラー**
    - 存在しないagent_id
    - 404 Not Found
3. **LLMエラー**
    - LM Studio接続失敗
    - タイムアウト
    - 500 Internal Server Error
4. **MCPエラー**
    - MCP Server接続失敗
    - ツール実行失敗
    - 500 Internal Server Error

### エラーレスポンス

**ストリーミング中のエラー**

```
event: error
data: {"type": "error", "error": "エラーメッセージ"}

event: done
data: {"message_id": null}
```

**通常エラー**

```json
{
  "detail": "エラー説明"
}
```

---

## ロギング

### ログレベル

- `DEBUG`: 開発時詳細情報
- `INFO`: 一般的な情報
- `WARNING`: 警告
- `ERROR`: エラー

### ログ内容

- APIリクエスト/レスポンス
- Agent選択
- MCPツール実行
- エラー詳細

---

## テスト戦略

### ユニットテスト

- Agentクラスの各メソッド
- MCP Clientのツール呼び出し
- Session管理

### 統合テスト

- APIエンドポイント
- ストリーミングフロー
- MCP統合

### E2Eテスト

- フロントからバックまでの完全なフロー
- ツール実行を含むシナリオ